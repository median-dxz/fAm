# fAm test Strategy

策略服务样例，使用简单的控制循环来调整 HPA 阈值。

基于 PIT 控制算法

具体算法如下：

1. 初始设定 CPU 平均使用率为 50%
2. 进行最大 6 轮循环
3. 每轮循环等待 5 分钟后，采集过去一分钟的服务平均响应时间（即等待 4 分钟的 HPA 调整）
4. 判断响应时间是否满足要求，使用离散的位置式 PID 算法确定控制增量（kp, ki, kd 为1效果就不错, pf = 0.5）（因为是阈值，故误差为负时应该尽快下调）
   1. $u_k = k_p * e_{k} + k_i * \sum\limits_{i=0}^k{e_i} + k_d * (e_k - e_{k-1}) (e > 0)$
   2. $u_k = (1 + pf) * k_p * e_{k} + k_i * \sum\limits_{i=0}^k{e_i} + k_d * (e_k - e_{k-1}) (e < 0)$ 
5. 循环结束或者到达迭代限制，取最优点（误差最小点）
6. 主动向控制器 apply 新的阈值

问题1：HPA调节周期相当长，采样出的数据会出现滞后问题，尤其是在缩容的时候，这会严重干扰控制器对过高控制量的评估

问题2：此外，pod数量在测试环境下是有限的离散值，因此实际平均响应时间也存在几个有限的波动范围，同时这也会影响CPU的平均负载，很难将其控制在某些值
